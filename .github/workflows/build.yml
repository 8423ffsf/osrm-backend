name: Build OSRM Backend

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-osrm-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-osrm-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-12 g++-12
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100
        sudo apt-get install -y \
          build-essential git cmake pkg-config \
          libbz2-dev libxml2-dev libzip-dev libboost-all-dev \
          lua5.2 liblua5.2-dev libtbb-dev \
          ccache

    - name: Configure and Build
      env:
        CCACHE_DIR: ~/.ccache
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_STANDARD=17 \
          -DCMAKE_CXX_FLAGS="-Wno-error=array-bounds -Wno-error=uninitialized -Wno-error=deprecated-declarations -Wno-stringop-overflow"
        
        cmake --build . -j4

    
    - name: Run Tests
      run: |
        cd build
        ctest --output-on-failure

    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: osrm-binaries
        path: |
          build/*.so
          build/osrm-*
        retention-days: 7
